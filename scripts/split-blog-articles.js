/**
 * One-time migration: split src/config/blogArticles.js into one file per article
 * under src/config/blog/articles/<slug>.js. Run: node scripts/split-blog-articles.js
 *
 * After running:
 * - blog/index.js will aggregate articles via import.meta.glob
 * - blogArticles.js will re-export from blog/index.js so all imports keep working
 * - Update generate-sitemap.js and submit-bing-indexnow.js to read slugs from articles dir
 */
import fs from 'fs'
import path from 'path'
import { fileURLToPath, pathToFileURL } from 'url'

const __dirname = path.dirname(fileURLToPath(import.meta.url))
const blogArticlesPath = path.resolve(__dirname, '../src/config/blogArticles.js')
const articlesDir = path.resolve(__dirname, '../src/config/blog/articles')

async function main() {
  const { BLOG_ARTICLES } = await import(pathToFileURL(blogArticlesPath).href)
  if (!Array.isArray(BLOG_ARTICLES) || BLOG_ARTICLES.length === 0) {
    console.error('[ERROR] BLOG_ARTICLES not found or empty')
    process.exit(1)
  }

  if (!fs.existsSync(articlesDir)) {
    fs.mkdirSync(articlesDir, { recursive: true })
    console.log('[OK] Created', articlesDir)
  }

  for (const article of BLOG_ARTICLES) {
    const slug = article.slug
    if (!slug) {
      console.warn('[WARN] Skipping article with no slug', article.title)
      continue
    }
    const safeContent = (article.content || '')
      .replace(/\\/g, '\\\\')
      .replace(/`/g, '\\`')
      .replace(/\$\{/g, '\\${')
    const lines = [
      '/**',
      ` * Blog article: ${slug}`,
      ' * Auto-generated by scripts/split-blog-articles.js. Do not edit the content here by hand if you run the split script again.',
      ' */',
      '',
      'export default {',
      `  slug: ${JSON.stringify(article.slug)},`,
      `  title: ${JSON.stringify(article.title)},`,
      `  excerpt: ${JSON.stringify(article.excerpt)},`,
      `  date: ${JSON.stringify(article.date)},`,
      `  topic: ${JSON.stringify(article.topic)},`,
      `  relatedServices: ${JSON.stringify(article.relatedServices || [])},`,
      `  relatedProjects: ${JSON.stringify(article.relatedProjects || [])},`,
      `  relatedArticleSlugs: ${JSON.stringify(article.relatedArticleSlugs || [])},`,
      `  author: ${JSON.stringify(article.author)},`,
      '  content: `' + safeContent + '`,',
      `  faqs: ${JSON.stringify(article.faqs || [], null, 2)}`,
      '}',
      ''
    ]
    const outPath = path.join(articlesDir, `${slug}.js`)
    fs.writeFileSync(outPath, lines.join('\n'), 'utf8')
    console.log('[OK]', slug)
  }

  console.log('[DONE] Wrote', BLOG_ARTICLES.length, 'article files to', articlesDir)
}

main().catch((err) => {
  console.error(err)
  process.exit(1)
})
