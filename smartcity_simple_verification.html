<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart City SVG Components - Simple Verification</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .component-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .component-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: 2px solid #ddd;
        }
        .component-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        .component-info {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 15px;
        }
        .svg-preview {
            width: 100%;
            height: 200px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            position: relative;
            overflow: hidden;
        }
        
        .component-highlight {
            position: absolute;
            border: 4px solid #00ff00;
            background: rgba(0, 255, 0, 0.1);
            pointer-events: none;
            z-index: 10;
        }
        .coordinate-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        .coordinate-inputs input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .verification-section {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        .verification-section label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }
        .summary {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .summary-stats {
            display: flex;
            gap: 30px;
            justify-content: center;
        }
        .summary-stat {
            text-align: center;
        }
        .summary-stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }
        .summary-stat-label {
            font-size: 0.9em;
            color: #666;
        }
        
        .component-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .section-header {
            grid-column: 1 / -1;
            background: #007bff;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: bold;
            font-size: 1.2em;
            text-align: center;
        }
        .loading {
            color: #666;
            font-style: italic;
        }
        .error {
            color: #dc3545;
            text-align: center;
        }
        .success {
            color: #28a745;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Smart City C4 Diagram - Component Verification</h1>
            <p>Verify and edit component coordinates with real-time SVG preview</p>
        </div>

        <div class="summary">
            <h2>Summary</h2>
            <div class="summary-stats">
                <div class="summary-stat">
                    <div class="summary-stat-value" id="totalCount">0</div>
                    <div class="summary-stat-label">Total Components</div>
                </div>
                <div class="summary-stat">
                    <div class="summary-stat-value" id="correctCount">0</div>
                    <div class="summary-stat-label">Correct</div>
                </div>
                <div class="summary-stat">
                    <div class="summary-stat-value" id="wrongCount">0</div>
                    <div class="summary-stat-label">Wrong</div>
                </div>
            </div>
        </div>

        <div id="componentsContainer" class="component-grid">
            <!-- Components will be loaded here -->
        </div>
    </div>

    <script>
        let componentsData = null;
        let fullSVG = null;

        // Load components data
        fetch('smartcity_final_coordinates.json')
            .then(response => response.json())
            .then(data => {
                componentsData = data;
                console.log('Loaded components:', data);
                loadSVGAndRender();
            })
            .catch(error => {
                console.error('Error loading components:', error);
                document.getElementById('componentsContainer').innerHTML = '<div class="error">Error loading components data</div>';
            });

        // Load full SVG
        function loadSVGAndRender() {
            fetch('public/assets/diagrams/SmartCity_C4_Diagram.svg')
                .then(response => response.text())
                .then(svgContent => {
                    fullSVG = svgContent;
                    console.log('Loaded SVG, length:', svgContent.length);
                    renderComponents();
                })
                .catch(error => {
                    console.error('Error loading SVG:', error);
                    document.getElementById('componentsContainer').innerHTML = '<div class="error">Error loading SVG</div>';
                });
        }

        function renderComponents() {
            const container = document.getElementById('componentsContainer');
            container.innerHTML = '';

            // 1. INDIVIDUAL SHAPES (38 regular shapes)
            addSectionHeader(container, 'Individual Shapes (38 regular shapes)');
            const individualContainer = document.createElement('div');
            individualContainer.className = 'component-grid';
            container.appendChild(individualContainer);
            
            if (componentsData.individual_shapes) {
                const regularShapes = componentsData.individual_shapes.slice(0, 38);
                regularShapes.forEach((shape, index) => {
                    const card = createComponentCard(shape, `individual_${index}`, 'rectangle');
                    individualContainer.appendChild(card);
                });
            }

            // 2. DATABASE SHAPES (4 database cylinders/polygons)
            addSectionHeader(container, 'Database Shapes (4 database cylinders)');
            const databaseContainer = document.createElement('div');
            databaseContainer.className = 'component-grid';
            container.appendChild(databaseContainer);
            
            for (let i = 38; i < 42; i++) {
                const dbShape = componentsData.individual_shapes[i] || {
                    text: `Database ${i - 37}`,
                    x: 1000 + (i * 100),
                    y: 1000 + (i * 50),
                    width: 200,
                    height: 150,
                    type: 'polygon'
                };
                const card = createComponentCard(dbShape, `database_${i - 38}`, 'polygon');
                databaseContainer.appendChild(card);
            }

            // 3. USERS CLUSTER (1 cluster with 4 users)
            addSectionHeader(container, 'Users Cluster (1 cluster with 4 users)');
            const usersContainer = document.createElement('div');
            usersContainer.className = 'component-grid';
            container.appendChild(usersContainer);
            
            if (componentsData.users && componentsData.users.length > 0) {
                componentsData.users.forEach((user, index) => {
                    const card = createComponentCard(user, `user_${index}`, 'users_cluster');
                    usersContainer.appendChild(card);
                });
            } else {
                // Create fallback users cluster
                const usersCluster = {
                    text: 'Users Cluster (4 users)',
                    x: 15301.0,
                    y: 110.3,
                    width: 4905.2,
                    height: 1542.0,
                    type: 'users_cluster'
                };
                const card = createComponentCard(usersCluster, 'user_0', 'users_cluster');
                usersContainer.appendChild(card);
            }

            // 4. GROUPS (8 groups)
            addSectionHeader(container, 'Groups (8 groups)');
            const groupsContainer = document.createElement('div');
            groupsContainer.className = 'component-grid';
            container.appendChild(groupsContainer);
            
            for (let i = 0; i < 8; i++) {
                const group = {
                    text: `Group ${i + 1}`,
                    x: 200 + (i * 200),
                    y: 200 + (i * 150),
                    width: 400,
                    height: 300,
                    type: 'group'
                };
                const card = createComponentCard(group, `group_${i}`, 'group');
                groupsContainer.appendChild(card);
            }

            updateStats();
        }

        function addSectionHeader(container, title) {
            const header = document.createElement('div');
            header.className = 'section-header';
            header.textContent = title;
            container.appendChild(header);
        }

        function createComponentCard(component, id, type) {
            const card = document.createElement('div');
            card.className = 'component-card';
            card.dataset.id = id;

            card.innerHTML = `
                <div class="component-title">
                    <input type="text" value="${component.text || 'Component'}" onchange="updateComponentName('${id}')" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                </div>
                <div class="component-info">
                    Type: ${type || component.type || 'unknown'} | Area: ${((component.width || 0) * (component.height || 0)).toFixed(0)} sq units
                </div>
                <div class="svg-preview" id="preview_${id}">
                    <div class="loading">Loading preview...</div>
                </div>
                <div class="coordinate-inputs">
                    <input type="number" value="${component.x || 0}" step="0.1" onchange="updateComponent('${id}', 'x')" placeholder="X">
                    <input type="number" value="${component.y || 0}" step="0.1" onchange="updateComponent('${id}', 'y')" placeholder="Y">
                    <input type="number" value="${component.width || 100}" step="0.1" onchange="updateComponent('${id}', 'width')" placeholder="Width">
                    <input type="number" value="${component.height || 100}" step="0.1" onchange="updateComponent('${id}', 'height')" placeholder="Height">
                </div>
                <div class="verification-section">
                    <label>Verification:</label>
                    <label><input type="radio" name="verify_${id}" value="correct" checked> Correct</label>
                    <label><input type="radio" name="verify_${id}" value="wrong"> Wrong</label>
                </div>
            `;

            // Initialize preview
            setTimeout(() => updateSVGPreview(id), 100);

            return card;
        }

        function updateSVGPreview(id) {
            if (!fullSVG) {
                console.log('SVG not loaded yet');
                return;
            }

            const card = document.querySelector(`[data-id="${id}"]`);
            const preview = card.querySelector('.svg-preview');
            
            // Use original coordinates - no scaling
            const x = parseFloat(card.querySelector('input[onchange*="x"]').value) || 0;
            const y = parseFloat(card.querySelector('input[onchange*="y"]').value) || 0;
            const width = parseFloat(card.querySelector('input[onchange*="width"]').value) || 100;
            const height = parseFloat(card.querySelector('input[onchange*="height"]').value) || 100;

            console.log(`Updating preview for ${id}:`, { x, y, width, height });

            // Validate coordinates
            if (isNaN(x) || isNaN(y) || isNaN(width) || isNaN(height) || width <= 0 || height <= 0) {
                preview.innerHTML = `
                    <div style="border: 6px solid #00ff00; padding: 20px; text-align: center; background: rgba(0, 255, 0, 0.1); border-radius: 4px;">
                        <div style="color: #00ff00; font-weight: bold;">Invalid Coordinates</div>
                        <div style="font-size: 0.9em; margin-top: 10px;">Please enter valid coordinates</div>
                    </div>
                `;
                return;
            }

            // Check if coordinates are within SVG bounds
            if (x + width > componentsData.width || y + height > componentsData.height) {
                preview.innerHTML = `
                    <div style="border: 6px solid #00ff00; padding: 20px; text-align: center; background: rgba(0, 255, 0, 0.1); border-radius: 4px;">
                        <div style="color: #00ff00; font-weight: bold;">Component Outside SVG Bounds</div>
                        <div style="font-size: 0.9em; margin-top: 10px;">X: ${x}, Y: ${y}, W: ${width}, H: ${height}</div>
                    </div>
                `;
                return;
            }

            try {
                // Create a tight viewBox around the component with minimal padding
                const padding = 20; // Very small padding
                const viewBoxX = Math.max(0, x - padding);
                const viewBoxY = Math.max(0, y - padding);
                const viewBoxWidth = Math.min(componentsData.width - viewBoxX, width + (padding * 2));
                const viewBoxHeight = Math.min(componentsData.height - viewBoxY, height + (padding * 2));

                console.log(`ViewBox for ${id}:`, { viewBoxX, viewBoxY, viewBoxWidth, viewBoxHeight });

                // Create cropped SVG
                let croppedSVG = fullSVG.replace(
                    'viewBox="0 0 20293 12756"',
                    `viewBox="${viewBoxX} ${viewBoxY} ${viewBoxWidth} ${viewBoxHeight}"`
                );
                
                // Update width and height to fit the display (like BAT file)
                croppedSVG = croppedSVG.replace(/width="[^"]*"/, 'width="400"');
                croppedSVG = croppedSVG.replace(/height="[^"]*"/, 'height="200"');

                // Add a highlight rectangle for the component (exactly like BAT file)
                const highlightRect = `<rect x="${x - viewBoxX}" y="${y - viewBoxY}" width="${width}" height="${height}" 
                    fill="rgba(0, 255, 0, 0.3)" stroke="#00ff00" stroke-width="10" stroke-dasharray="5,5"/>`;
                
                console.log(`Adding highlight for ${id}:`, { 
                    x: x - viewBoxX, 
                    y: y - viewBoxY, 
                    width, 
                    height,
                    highlightRect 
                });
                
                // Insert the highlight before the closing </svg> tag
                croppedSVG = croppedSVG.replace('</svg>', highlightRect + '</svg>');
                
                console.log(`SVG after highlight addition:`, croppedSVG.includes(highlightRect));
                console.log(`SVG length after highlight:`, croppedSVG.length);
                console.log(`SVG ends with:`, croppedSVG.slice(-100));
                
                // Set the cropped SVG directly (exactly like BAT file)
                preview.innerHTML = croppedSVG;
            } catch (error) {
                console.error(`Error creating preview for ${id}:`, error);
                preview.innerHTML = `
                    <div style="border: 6px solid #00ff00; padding: 20px; text-align: center; background: rgba(0, 255, 0, 0.1); border-radius: 4px;">
                        <div style="color: #00ff00; font-weight: bold;">Error Creating Preview</div>
                        <div style="font-size: 0.9em; margin-top: 10px;">${error.message}</div>
                    </div>
                `;
            }
        }

        function updateComponent(id, field) {
            const card = document.querySelector(`[data-id="${id}"]`);
            const value = parseFloat(card.querySelector(`input[onchange*="${field}"]`).value) || 0;
            console.log(`Updated ${field} for ${id}:`, value);
            updateSVGPreview(id);
        }

        function updateComponentName(id) {
            const card = document.querySelector(`[data-id="${id}"]`);
            const name = card.querySelector('input[type="text"]').value;
            console.log(`Updated name for ${id}:`, name);
        }

        function updateStats() {
            const totalCards = document.querySelectorAll('.component-card').length;
            const correctCards = document.querySelectorAll('input[value="correct"]:checked').length;
            const wrongCards = document.querySelectorAll('input[value="wrong"]:checked').length;

            document.getElementById('totalCount').textContent = totalCards;
            document.getElementById('correctCount').textContent = correctCards;
            document.getElementById('wrongCount').textContent = wrongCards;
        }
    </script>
</body>
</html>
