<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BAT Real SVG Component Verification Tool</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        .component-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .component-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .component-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        .svg-cropper {
            border: 2px solid #ddd;
            border-radius: 8px;
            margin: 15px 0;
            background: #fafafa;
            height: 250px;
            width: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            position: relative;
            overflow: hidden;
        }
        .svg-cropper svg {
            max-width: 100%;
            max-height: 100%;
        }
        .component-highlight {
            position: absolute;
            border: 4px solid #00ff00;
            background: rgba(0, 255, 0, 0.1);
            pointer-events: none;
            z-index: 10;
        }
        .component-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .component-title input {
            flex: 1;
            padding: 5px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            font-weight: bold;
        }
        .coordinate-inputs {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }
        .coordinate-inputs input {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
        }
        .verification-section {
            margin: 15px 0;
        }
        .verification-section label {
            display: inline-block;
            margin-right: 15px;
            font-weight: bold;
            font-size: 14px;
        }
        .verification-section input[type="radio"] {
            margin-right: 5px;
        }
        .output-section {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 20px;
            margin-top: 30px;
        }
        .output-section textarea {
            width: 100%;
            height: 200px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .component-info {
            font-size: 12px;
            color: #666;
            margin-bottom: 10px;
        }
        .stats {
            background: #e9ecef;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
        }
        .loading {
            text-align: center;
            color: #666;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>BAT Real SVG Component Verification Tool</h1>
        <p>Verify and correct coordinates for all 37 individual shapes and 8 main groups</p>
    </div>

    <div class="stats">
        <strong id="stats-text">Processing components...</strong>
    </div>

    <div id="components-container" class="component-grid">
        <div class="loading">Loading components...</div>
    </div>

    <div class="header" style="margin-top: 40px;">
        <h2>üîç Database Components to Identify</h2>
        <p>Find the 4 database shapes in the SVG and update their coordinates</p>
    </div>

        <div class="stats">
            <strong>4 Database Components - All Verified Correct!</strong>
        </div>

    <div id="database-container" class="component-grid">
        <!-- Database components will be shown here -->
    </div>

    <div class="header" style="margin-top: 40px;">
        <h2>üì¶ Group Components - All Verified</h2>
        <p>9 architectural groups - ALL verified correct with proper boundaries</p>
    </div>

    <div class="stats">
        <strong>9 Group Components - ALL Verified Correct!</strong>
    </div>

    <div id="group-container" class="component-grid">
        <!-- Group components will be shown here -->
    </div>

    <div class="output-section" style="margin-top: 40px;">
        <h3>üìä Export Results</h3>
        <p>Export verification results for further processing</p>
        <button class="btn" onclick="exportResults()">Export Results</button>
        <button class="btn" onclick="exportCSV()">Export CSV</button>
        <button class="btn" onclick="exportForNarration()">Export for batNarration.js</button>
        <textarea id="output" placeholder="Verification results will appear here..."></textarea>
    </div>

    <script>
        // Store verified correct components
        let allComponents = [
            // Verified correct components (37 individual shapes)
            {"name": "1. SAP Planet 8/9", "x": 25811.44, "y": 6277.75, "width": 529.64, "height": 273.49, "type": "rectangle", "entity_id": "", "text": "", "category": "external", "number": 1, "verified": true},
            {"name": "2. Cherwell HR", "x": 21073.94, "y": 6277.75, "width": 529.64, "height": 273.49, "type": "rectangle", "entity_id": "", "text": "", "category": "external", "number": 2, "verified": true},
            {"name": "3. Power Apps", "x": 22227.06, "y": 6277.75, "width": 529.64, "height": 273.49, "type": "rectangle", "entity_id": "", "text": "", "category": "external", "number": 3, "verified": true},
            {"name": "4. Microsoft Teams", "x": 24658.31, "y": 6277.75, "width": 529.64, "height": 273.49, "type": "rectangle", "entity_id": "", "text": "", "category": "external", "number": 4, "verified": true},
            {"name": "5. Azure AD", "x": 18768.44, "y": 6277.75, "width": 529.64, "height": 273.49, "type": "rectangle", "entity_id": "", "text": "", "category": "external", "number": 5, "verified": true},
            {"name": "6. Azure Data Lake", "x": 19921.56, "y": 6277.75, "width": 529.64, "height": 273.49, "type": "rectangle", "entity_id": "", "text": "", "category": "external", "number": 6, "verified": true},
            {"name": "7. ML Platform", "x": 11295, "y": 10188, "width": 488, "height": 317, "type": "rectangle", "entity_id": "", "text": "", "category": "service", "number": 7, "verified": true},
            {"name": "8. Backup Service", "x": 1992, "y": 10188, "width": 494, "height": 317, "type": "rectangle", "entity_id": "", "text": "", "category": "service", "number": 8, "verified": true},
            {"name": "9. Azure Monitor", "x": 10702, "y": 9195, "width": 462, "height": 368, "type": "rectangle", "entity_id": "", "text": "", "category": "azure", "number": 9, "verified": true},
            {"name": "10. Event Grid", "x": 15648, "y": 8253, "width": 538, "height": 317, "type": "rectangle", "entity_id": "", "text": "", "category": "azure", "number": 10, "verified": true},
            {"name": "11. Cherwell IT", "x": 26967, "y": 6278, "width": 643, "height": 273, "type": "rectangle", "entity_id": "", "text": "", "category": "external", "number": 11, "verified": true},
            {"name": "12. SharePoint", "x": 23382, "y": 6278, "width": 651, "height": 273, "type": "rectangle", "entity_id": "", "text": "", "category": "external", "number": 12, "verified": true},
            {"name": "13. Reporting Service", "x": 786, "y": 11144, "width": 567, "height": 317, "type": "rectangle", "entity_id": "", "text": "", "category": "service", "number": 13, "verified": true},
            {"name": "14. Auth Service", "x": 5704, "y": 5201, "width": 481, "height": 375, "type": "rectangle", "entity_id": "", "text": "", "category": "service", "number": 14, "verified": true},
            {"name": "15. Service Bus", "x": 15641, "y": 7282, "width": 571, "height": 317, "type": "rectangle", "entity_id": "", "text": "", "category": "azure", "number": 15, "verified": true},
            {"name": "16. Stream Analytics", "x": 15622, "y": 10188, "width": 583, "height": 317, "type": "rectangle", "entity_id": "", "text": "", "category": "azure", "number": 16, "verified": true},
            {"name": "17. Analytics Service", "x": 5615, "y": 4233, "width": 586, "height": 317, "type": "rectangle", "entity_id": "", "text": "", "category": "service", "number": 17, "verified": true},
            {"name": "18. Power BI", "x": 10083, "y": 10188, "width": 586, "height": 317, "type": "rectangle", "entity_id": "", "text": "", "category": "azure", "number": 18, "verified": true},
            {"name": "19. Angular Portal", "x": 1390, "y": 1280, "width": 511, "height": 368, "type": "rectangle", "entity_id": "", "text": "", "category": "frontend", "number": 19, "verified": true},
            {"name": "20. Monitoring Service", "x": 772, "y": 10188, "width": 596, "height": 317, "type": "rectangle", "entity_id": "", "text": "", "category": "service", "number": 20, "verified": true},
            {"name": "21. Audit Service", "x": 3110, "y": 10188, "width": 602, "height": 317, "type": "rectangle", "entity_id": "", "text": "", "category": "service", "number": 21, "verified": true},
            {"name": "22. Integration Service", "x": 6824, "y": 4233, "width": 605, "height": 317, "type": "rectangle", "entity_id": "", "text": "", "category": "service", "number": 22, "verified": true},
            {"name": "23. Azure Functions", "x": 15605, "y": 9221, "width": 605, "height": 317, "type": "rectangle", "entity_id": "", "text": "", "category": "azure", "number": 23, "verified": true},
            {"name": "24. Notification Service", "x": 6811, "y": 5230, "width": 618, "height": 317, "type": "rectangle", "entity_id": "", "text": "", "category": "service", "number": 24, "verified": true},
            {"name": "25. App Insights", "x": 10620, "y": 8253, "width": 625, "height": 317, "type": "rectangle", "entity_id": "", "text": "", "category": "azure", "number": 25, "verified": true},
            {"name": "26. Analytics Dashboard", "x": 3814, "y": 1305, "width": 643, "height": 317, "type": "rectangle", "entity_id": "", "text": "", "category": "frontend", "number": 26, "verified": true},
            {"name": "27. Security Gateway", "x": 1919, "y": 4208, "width": 558, "height": 368, "type": "rectangle", "entity_id": "", "text": "", "category": "gateway", "number": 27, "verified": true},
            {"name": "28. IT Service", "x": 4416, "y": 7253, "width": 552, "height": 375, "type": "rectangle", "entity_id": "", "text": "", "category": "service", "number": 28, "verified": true},
            {"name": "29. App Gateway", "x": 1921, "y": 3266, "width": 660, "height": 317, "type": "rectangle", "entity_id": "", "text": "", "category": "gateway", "number": 29, "verified": true},
            {"name": "30. Admin Dashboard", "x": 2525, "y": 1305, "width": 664, "height": 317, "type": "rectangle", "entity_id": "", "text": "", "category": "frontend", "number": 30, "verified": true},
            {"name": "31. Saga Orchestrator", "x": 4416, "y": 5230, "width": 665, "height": 317, "type": "rectangle", "entity_id": "", "text": "", "category": "service", "number": 31, "verified": true},
            {"name": "32. Mobile PWA", "x": 88, "y": 1305, "width": 677, "height": 317, "type": "rectangle", "entity_id": "", "text": "", "category": "frontend", "number": 32, "verified": true},
            {"name": "33. HR Service", "x": 5050, "y": 6201, "width": 528, "height": 426, "type": "rectangle", "entity_id": "", "text": "", "category": "service", "number": 33, "verified": true},
            {"name": "34. API Management", "x": 1942, "y": 2273, "width": 619, "height": 368, "type": "rectangle", "entity_id": "", "text": "", "category": "gateway", "number": 34, "verified": true},
            {"name": "35. Business Analyst", "x": 3865, "y": 206, "width": 541, "height": 423, "type": "rectangle", "entity_id": "", "text": "", "category": "person", "number": 35, "verified": true},
            {"name": "36. BAT Employee", "x": 741, "y": 180, "width": 558, "height": 474, "type": "rectangle", "entity_id": "", "text": "", "category": "person", "number": 36, "verified": true},
            {"name": "37. System Admin", "x": 2518, "y": 206, "width": 680, "height": 423, "type": "rectangle", "entity_id": "", "text": "", "category": "person", "number": 37, "verified": true},
            
            // 4 Database shapes (verified correct)
            {"name": "38. Azure SQL Database", "x": 15600, "y": 11120, "width": 640, "height": 350, "type": "database", "entity_id": "", "text": "", "category": "database", "number": 38, "verified": true},
            {"name": "39. Azure Cosmos DB", "x": 16860, "y": 11120, "width": 565, "height": 350, "type": "database", "entity_id": "", "text": "", "category": "database", "number": 39, "verified": true},
            {"name": "40. Data Lake Storage", "x": 18050, "y": 11120, "width": 590, "height": 350, "type": "database", "entity_id": "", "text": "", "category": "database", "number": 40, "verified": true},
            {"name": "41. Redis Cache", "x": 19260, "y": 11120, "width": 670, "height": 350, "type": "database", "entity_id": "", "text": "", "category": "database", "number": 41, "verified": true},
            
            // 9 Group boxes (verified correct boundaries)
            {"name": "42. Enterprise Frontend Portal", "x": 50, "y": 1170, "width": 4550, "height": 550, "type": "group", "entity_id": "", "text": "Frontend/UI Components", "category": "group", "number": 42, "verified": true},
            {"name": "43. Azure API Gateway", "x": 1870, "y": 2200, "width": 770, "height": 2500, "type": "group", "entity_id": "", "text": "Gateway/Security Layer", "category": "group", "number": 43, "verified": true},
            {"name": "44. Azure Service Fabric Microservices", "x": 4350, "y": 4110, "width": 3200, "height": 3680, "type": "group", "entity_id": "", "text": "Core Business Services", "category": "group", "number": 44, "verified": true},
            {"name": "45. Monitoring & Analytics", "x": 10050, "y": 8130, "width": 1820, "height": 2500, "type": "group", "entity_id": "", "text": "Data Processing Services", "category": "group", "number": 45, "verified": true},
            {"name": "46. Event Processing", "x": 15530, "y": 7150, "width": 760, "height": 3560, "type": "group", "entity_id": "", "text": "Azure Platform Services", "category": "group", "number": 46, "verified": true},
            {"name": "47. Database Layer", "x": 15530, "y": 11000, "width": 4580, "height": 550, "type": "group", "entity_id": "", "text": "Data Storage Layer", "category": "group", "number": 47, "verified": true},
            {"name": "48. External Systems", "x": 18690, "y": 6150, "width": 9200, "height": 480, "type": "group", "entity_id": "", "text": "External Integrations", "category": "group", "number": 48, "verified": true},
            {"name": "49. User Personas", "x": 720, "y": 160, "width": 3800, "height": 530, "type": "group", "entity_id": "", "text": "User Types", "category": "group", "number": 49, "verified": true},
            
            // Support Services group (verified correct)
            {"name": "50. Support Services", "x": 700, "y": 10060, "width": 3150, "height": 1530, "type": "group", "entity_id": "", "text": "Support Services", "category": "group", "number": 50, "verified": true}
        ];
        
        
        let fullSVG = null;
        
        async function loadSVG() {
            try {
                const response = await fetch('/assets/diagrams/BAT_InhouseApp_C4_Diagram.svg');
                const svgText = await response.text();
                fullSVG = svgText;
                console.log('SVG loaded successfully');
                generateComponents();
            } catch (error) {
                console.error('Error loading SVG:', error);
                document.getElementById('components-container').innerHTML = '<div class="loading">Error loading SVG. Please check the file path.</div>';
            }
        }
        
        function updateComponent(index) {
            const component = allComponents[index];
            component.x = parseFloat(document.getElementById(`x_${index}`).value);
            component.y = parseFloat(document.getElementById(`y_${index}`).value);
            component.width = parseFloat(document.getElementById(`w_${index}`).value);
            component.height = parseFloat(document.getElementById(`h_${index}`).value);
            
            // Update the SVG cropper
            updateSVGCropper(index);
        }
        
        function updateComponentName(index) {
            const component = allComponents[index];
            component.name = document.getElementById(`name_${index}`).value;
        }
        
        function updateSVGCropper(index) {
            if (!fullSVG) return;
            
            const component = allComponents[index];
            const cropper = document.getElementById(`cropper_${index}`);
            
            // Calculate the viewBox to show the component area with some padding
            const padding = 200;
            const viewBoxX = Math.max(0, component.x - padding);
            const viewBoxY = Math.max(0, component.y - padding);
            const viewBoxWidth = component.width + (padding * 2);
            const viewBoxHeight = component.height + (padding * 2);
            
            // Create cropped SVG
            const croppedSVG = fullSVG.replace(
                'viewBox="0 0 27681 11856"',
                `viewBox="${viewBoxX} ${viewBoxY} ${viewBoxWidth} ${viewBoxHeight}"`
            );
            
            cropper.innerHTML = croppedSVG;
            
            // Add red border highlighting the exact component area
            const highlight = document.createElement('div');
            highlight.className = 'component-highlight';
            
            // Calculate the position of the component within the cropped view
            const componentX = component.x - viewBoxX;
            const componentY = component.y - viewBoxY;
            
            // Calculate the scale factor based on the cropper size
            const scaleX = 400 / viewBoxWidth;  // 400px is the cropper width
            const scaleY = 250 / viewBoxHeight; // 250px is the cropper height
            
            // Position and size the highlight
            highlight.style.left = `${componentX * scaleX}px`;
            highlight.style.top = `${componentY * scaleY}px`;
            highlight.style.width = `${component.width * scaleX}px`;
            highlight.style.height = `${component.height * scaleY}px`;
            
            cropper.appendChild(highlight);
        }
        
        function generateComponents() {
            const container = document.getElementById('components-container');
            container.innerHTML = '';
            
            // Update stats
            const individualShapes = allComponents.filter(c => c.type === 'rectangle').length;
            const databases = allComponents.filter(c => c.type === 'database').length;
            const groups = allComponents.filter(c => c.type === 'group').length;
            const verifiedCount = allComponents.filter(c => c.verified).length;
            document.getElementById('stats-text').innerHTML = 
                `<strong>Found: ${individualShapes} Individual Shapes + ${databases} Databases + ${groups} Main Groups = ${allComponents.length} Total Components (${verifiedCount} Verified Correct, ${allComponents.length - verifiedCount} to Identify)</strong>`;
            
            // Generate main components (non-database)
            allComponents.filter(c => c.type !== 'database').forEach((component, index) => {
                const card = document.createElement('div');
                card.className = 'component-card';
                
                // Pre-select "correct" for verified components
                const correctChecked = component.verified ? 'checked' : '';
                const wrongChecked = component.verified ? '' : '';
                
                card.innerHTML = `
                    <div class="component-title">
                        <input type="text" id="name_${index}" value="${component.name}" onchange="updateComponentName(${index})" placeholder="Component Name">
                    </div>
                    <div class="component-info">
                        Type: ${component.type} | Category: ${component.category}<br>
                        Entity ID: ${component.entity_id}<br>
                        Text: ${component.text}
                    </div>
                    <div class="svg-cropper" id="cropper_${index}">
                        <div class="loading">Loading SVG...</div>
                    </div>
                    <div class="coordinate-inputs">
                        <input type="number" id="x_${index}" value="${component.x}" step="0.1" onchange="updateComponent(${index})" placeholder="X">
                        <input type="number" id="y_${index}" value="${component.y}" step="0.1" onchange="updateComponent(${index})" placeholder="Y">
                        <input type="number" id="w_${index}" value="${component.width}" step="0.1" onchange="updateComponent(${index})" placeholder="Width">
                        <input type="number" id="h_${index}" value="${component.height}" step="0.1" onchange="updateComponent(${index})" placeholder="Height">
                    </div>
                    <div class="verification-section">
                        <label>Verification:</label>
                        <label><input type="radio" name="verify_${index}" value="correct" ${correctChecked}> Correct</label>
                        <label><input type="radio" name="verify_${index}" value="wrong" ${wrongChecked}> Wrong</label>
                    </div>
                `;
                
                container.appendChild(card);
                
                // Initialize the SVG cropper
                updateSVGCropper(index);
            });
            
            // Generate database components section
            generateDatabaseComponents();
            
            // Generate group components section
            generateGroupComponents();
        }
        
        function generateDatabaseComponents() {
            const container = document.getElementById('database-container');
            container.innerHTML = '';
            
            const databaseComponents = allComponents.filter(c => c.type === 'database');
            
            databaseComponents.forEach((component, index) => {
                const card = document.createElement('div');
                card.className = 'component-card';
                card.style.border = '3px solid #00ff00'; // Green border for verified databases
                card.style.backgroundColor = '#f0fff0'; // Light green background
                
                card.innerHTML = `
                    <div class="component-title">
                        <input type="text" id="db_name_${index}" value="${component.name}" onchange="updateDatabaseName(${index})" placeholder="Database Name">
                    </div>
                    <div class="component-info">
                        Type: ${component.type} | Category: ${component.category}<br>
                        Entity ID: ${component.entity_id}<br>
                        Text: ${component.text}<br>
                        <strong style="color: #00aa00;">‚úÖ VERIFIED CORRECT - Database coordinates identified</strong>
                    </div>
                    <div class="svg-cropper" id="db_cropper_${index}">
                        <div class="loading">Database location to be identified...</div>
                    </div>
                    <div class="coordinate-inputs">
                        <input type="number" id="db_x_${index}" value="${component.x}" step="0.1" onchange="updateDatabaseComponent(${index})" placeholder="X">
                        <input type="number" id="db_y_${index}" value="${component.y}" step="0.1" onchange="updateDatabaseComponent(${index})" placeholder="Y">
                        <input type="number" id="db_w_${index}" value="${component.width}" step="0.1" onchange="updateDatabaseComponent(${index})" placeholder="Width">
                        <input type="number" id="db_h_${index}" value="${component.height}" step="0.1" onchange="updateDatabaseComponent(${index})" placeholder="Height">
                    </div>
                    <div class="verification-section">
                        <label>Verification:</label>
                        <label><input type="radio" name="db_verify_${index}" value="correct" checked> Correct</label>
                        <label><input type="radio" name="db_verify_${index}" value="wrong"> Wrong</label>
                    </div>
                `;
                
                container.appendChild(card);
                
                // Initialize the SVG cropper for databases
                updateDatabaseSVGCropper(index);
            });
        }
        
        function generateGroupComponents() {
            const container = document.getElementById('group-container');
            container.innerHTML = '';
            
            const groupComponents = allComponents.filter(c => c.type === 'group');
            
            groupComponents.forEach((component, index) => {
                const card = document.createElement('div');
                card.className = 'component-card';
                
                // Use green border for verified groups, red for unverified
                if (component.verified) {
                    card.style.border = '3px solid #00ff00'; // Green border for verified groups
                    card.style.backgroundColor = '#f0fff0'; // Light green background
                } else {
                    card.style.border = '3px solid #ff6b6b'; // Red border for groups to identify
                    card.style.backgroundColor = '#fff5f5'; // Light red background
                }
                
                card.innerHTML = `
                    <div class="component-title">
                        <input type="text" id="grp_name_${index}" value="${component.name}" onchange="updateGroupName(${index})" placeholder="Group Name">
                    </div>
                    <div class="component-info">
                        Type: ${component.type} | Category: ${component.category}<br>
                        Entity ID: ${component.entity_id}<br>
                        Text: ${component.text}<br>
                        <strong style="color: ${component.verified ? '#00aa00' : '#ff6b6b'};">${component.verified ? '‚úÖ VERIFIED CORRECT - Group boundary identified' : '‚ö†Ô∏è NEEDS COORDINATES - Find this group boundary in the SVG'}</strong>
                    </div>
                    <div class="svg-cropper" id="grp_cropper_${index}">
                        <div class="loading">Group boundary to be identified...</div>
                    </div>
                    <div class="coordinate-inputs">
                        <input type="number" id="grp_x_${index}" value="${component.x}" step="0.1" onchange="updateGroupComponent(${index})" placeholder="X">
                        <input type="number" id="grp_y_${index}" value="${component.y}" step="0.1" onchange="updateGroupComponent(${index})" placeholder="Y">
                        <input type="number" id="grp_w_${index}" value="${component.width}" step="0.1" onchange="updateGroupComponent(${index})" placeholder="Width">
                        <input type="number" id="grp_h_${index}" value="${component.height}" step="0.1" onchange="updateGroupComponent(${index})" placeholder="Height">
                    </div>
                    <div class="verification-section">
                        <label>Verification:</label>
                        <label><input type="radio" name="grp_verify_${index}" value="correct" ${component.verified ? 'checked' : ''}> Correct</label>
                        <label><input type="radio" name="grp_verify_${index}" value="wrong" ${component.verified ? '' : 'checked'}> Wrong</label>
                    </div>
                `;
                
                container.appendChild(card);
                
                // Initialize the SVG cropper for groups
                updateGroupSVGCropper(index);
            });
        }
        
        function updateDatabaseComponent(index) {
            const databaseComponents = allComponents.filter(c => c.type === 'database');
            const component = databaseComponents[index];
            component.x = parseFloat(document.getElementById(`db_x_${index}`).value);
            component.y = parseFloat(document.getElementById(`db_y_${index}`).value);
            component.width = parseFloat(document.getElementById(`db_w_${index}`).value);
            component.height = parseFloat(document.getElementById(`db_h_${index}`).value);
            
            // Update the SVG cropper
            updateDatabaseSVGCropper(index);
        }
        
        function updateDatabaseName(index) {
            const databaseComponents = allComponents.filter(c => c.type === 'database');
            const component = databaseComponents[index];
            component.name = document.getElementById(`db_name_${index}`).value;
        }
        
        function updateGroupComponent(index) {
            const groupComponents = allComponents.filter(c => c.type === 'group');
            const component = groupComponents[index];
            component.x = parseFloat(document.getElementById(`grp_x_${index}`).value);
            component.y = parseFloat(document.getElementById(`grp_y_${index}`).value);
            component.width = parseFloat(document.getElementById(`grp_w_${index}`).value);
            component.height = parseFloat(document.getElementById(`grp_h_${index}`).value);
            
            updateGroupSVGCropper(index);
        }
        
        function updateGroupName(index) {
            const groupComponents = allComponents.filter(c => c.type === 'group');
            const component = groupComponents[index];
            component.name = document.getElementById(`grp_name_${index}`).value;
        }
        
        function updateGroupSVGCropper(index) {
            if (!fullSVG) return;
            
            const groupComponents = allComponents.filter(c => c.type === 'group');
            const component = groupComponents[index];
            const cropper = document.getElementById(`grp_cropper_${index}`);
            
            if (component.x === 0 && component.y === 0 && component.width === 0 && component.height === 0) {
                cropper.innerHTML = '<div class="loading">Group boundary to be identified...</div>';
                return;
            }
            
            const padding = 200;
            const viewBoxX = Math.max(0, component.x - padding);
            const viewBoxY = Math.max(0, component.y - padding);
            const viewBoxWidth = component.width + (padding * 2);
            const viewBoxHeight = component.height + (padding * 2);
            
            const croppedSVG = fullSVG.replace(
                'viewBox="0 0 27681 11856"',
                `viewBox="${viewBoxX} ${viewBoxY} ${viewBoxWidth} ${viewBoxHeight}"`
            );
            
            cropper.innerHTML = croppedSVG;
            
            const highlight = document.createElement('div');
            highlight.className = 'component-highlight';
            
            const componentX = component.x - viewBoxX;
            const componentY = component.y - viewBoxY;
            
            const scaleX = 400 / viewBoxWidth;
            const scaleY = 250 / viewBoxHeight;
            
            highlight.style.left = `${componentX * scaleX}px`;
            highlight.style.top = `${componentY * scaleY}px`;
            highlight.style.width = `${component.width * scaleX}px`;
            highlight.style.height = `${component.height * scaleY}px`;
            
            cropper.appendChild(highlight);
        }
        
        function updateDatabaseSVGCropper(index) {
            if (!fullSVG) return;
            
            const databaseComponents = allComponents.filter(c => c.type === 'database');
            const component = databaseComponents[index];
            const cropper = document.getElementById(`db_cropper_${index}`);
            
            if (component.x === 0 && component.y === 0 && component.width === 0 && component.height === 0) {
                cropper.innerHTML = '<div class="loading">Database location to be identified...</div>';
                return;
            }
            
            // Calculate the viewBox to show the component area with some padding
            const padding = 200;
            const viewBoxX = Math.max(0, component.x - padding);
            const viewBoxY = Math.max(0, component.y - padding);
            const viewBoxWidth = component.width + (padding * 2);
            const viewBoxHeight = component.height + (padding * 2);
            
            // Create cropped SVG
            const croppedSVG = fullSVG.replace(
                'viewBox="0 0 27681 11856"',
                `viewBox="${viewBoxX} ${viewBoxY} ${viewBoxWidth} ${viewBoxHeight}"`
            );
            
            cropper.innerHTML = croppedSVG;
            
            // Add red border highlighting the exact component area
            const highlight = document.createElement('div');
            highlight.className = 'component-highlight';
            
            // Calculate the position of the component within the cropped view
            const componentX = component.x - viewBoxX;
            const componentY = component.y - viewBoxY;
            
            // Calculate the scale factor based on the cropper size
            const scaleX = 400 / viewBoxWidth;  // 400px is the cropper width
            const scaleY = 250 / viewBoxHeight; // 250px is the cropper height
            
            // Position and size the highlight
            highlight.style.left = `${componentX * scaleX}px`;
            highlight.style.top = `${componentY * scaleY}px`;
            highlight.style.width = `${component.width * scaleX}px`;
            highlight.style.height = `${component.height * scaleY}px`;
            
            cropper.appendChild(highlight);
        }
        
        function exportResults() {
            const results = [];
            
            allComponents.forEach((component, index) => {
                const verification = document.querySelector(`input[name="verify_${index}"]:checked`);
                results.push({
                    name: component.name,
                    type: component.type,
                    category: component.category,
                    entity_id: component.entity_id,
                    x: component.x,
                    y: component.y,
                    width: component.width,
                    height: component.height,
                    text: component.text,
                    verification: verification ? verification.value : 'not_verified'
                });
            });
            
            document.getElementById('output').value = JSON.stringify(results, null, 2);
        }
        
        function exportCSV() {
            const results = [];
            
            allComponents.forEach((component, index) => {
                let verification = 'not_verified';
                
                // Check verification based on component type
                if (component.type === 'database') {
                    const dbIndex = allComponents.filter(c => c.type === 'database').indexOf(component);
                    const dbVerification = document.querySelector(`input[name="db_verify_${dbIndex}"]:checked`);
                    verification = dbVerification ? dbVerification.value : 'not_verified';
                } else if (component.type === 'group') {
                    const grpIndex = allComponents.filter(c => c.type === 'group').indexOf(component);
                    const grpVerification = document.querySelector(`input[name="grp_verify_${grpIndex}"]:checked`);
                    verification = grpVerification ? grpVerification.value : 'not_verified';
                } else {
                    // Individual shapes (rectangles)
                    const mainIndex = allComponents.filter(c => c.type !== 'database' && c.type !== 'group').indexOf(component);
                    const mainVerification = document.querySelector(`input[name="verify_${mainIndex}"]:checked`);
                    verification = mainVerification ? mainVerification.value : 'not_verified';
                }
                
                results.push({
                    name: component.name,
                    type: component.type,
                    category: component.category,
                    entity_id: component.entity_id,
                    x: component.x,
                    y: component.y,
                    width: component.width,
                    height: component.height,
                    text: component.text,
                    verification: verification
                });
            });
            
            // Convert to CSV
            const headers = ['name', 'type', 'category', 'entity_id', 'x', 'y', 'width', 'height', 'text', 'verification'];
            const csvContent = [
                headers.join(','),
                ...results.map(row => headers.map(header => `"${row[header]}"`).join(','))
            ].join('\n');
            
            document.getElementById('output').value = csvContent;
        }
        
        function exportForNarration() {
            const results = [];
            
            allComponents.forEach((component, index) => {
                const verification = document.querySelector(`input[name="verify_${index}"]:checked`);
                if (verification && verification.value === 'correct') {
                    results.push({
                        title: component.name,
                        description: component.text || `This is the ${component.name} component`,
                        highlights: [component.x, component.y, component.width, component.height]
                    });
                }
            });
            
            document.getElementById('output').value = JSON.stringify(results, null, 2);
        }
        
        // Initialize the page
        window.onload = function() {
            loadSVG();
        };
    </script>
</body>
</html>
