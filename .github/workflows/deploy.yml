name: Deploy Redirect to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch: # Allow manual trigger from any branch
    inputs:
      branch:
        description: 'Branch to deploy from'
        required: false
        default: 'main'
        type: string

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch || github.ref }}
      
      - name: Create redirect HTML
        run: |
          mkdir -p dist/portfolio
          # Create redirect HTML for /portfolio/ path
          cat > dist/portfolio/index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="robots" content="noindex, nofollow">
            <meta http-equiv="refresh" content="0; url=https://waqasahmad-portfolio.web.app/">
            <link rel="canonical" href="https://waqasahmad-portfolio.web.app/">
            <title>Redirecting to Waqas Ahmad Portfolio...</title>
            <script>
              // Redirect to Firebase, preserving path and query params
              const path = window.location.pathname.replace('/portfolio', '') || '/';
              const search = window.location.search;
              const hash = window.location.hash;
              window.location.replace('https://waqasahmad-portfolio.web.app' + path + search + hash);
            </script>
          </head>
          <body>
            <p>This site has moved to <a href="https://waqasahmad-portfolio.web.app/">https://waqasahmad-portfolio.web.app/</a></p>
            <p>Redirecting...</p>
          </body>
          </html>
          EOF
          # Also create root redirect for custom domain scenarios
          mkdir -p dist
          cp dist/portfolio/index.html dist/index.html
          
          # Create robots.txt to prevent indexing of GitHub Pages (it's just a redirect)
          cat > dist/robots.txt << 'EOF'
          User-agent: *
          Disallow: /
          EOF
          
          # Create robots.txt in portfolio folder too
          cp dist/robots.txt dist/portfolio/robots.txt
      
      - name: Setup Pages
        uses: actions/configure-pages@v4
      
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './dist'
          retention-days: 1
      
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
